<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="Asciidoctor 0.1.3">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Clojure Omnibus</title>
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
article, aside, details, figcaption, figure, footer, header, hgroup, main, nav, section, summary { display: block; }
audio, canvas, video { display: inline-block; }
audio:not([controls]) { display: none; height: 0; }
[hidden] { display: none; }
html { font-family: sans-serif; -webkit-text-size-adjust: 100%; -ms-text-size-adjust: 100%; }
body { margin: 0; }
a:focus { outline: thin dotted; }
a:active, a:hover { outline: 0; }
h1 { font-size: 2em; margin: 0.67em 0; }
abbr[title] { border-bottom: 1px dotted; }
b, strong { font-weight: bold; }
dfn { font-style: italic; }
hr { -moz-box-sizing: content-box; box-sizing: content-box; height: 0; }
mark { background: #ff0; color: #000; }
code, tt, kbd, pre, samp { font-family: monospace, serif; font-size: 1em; }
pre { white-space: pre-wrap; }
q { quotes: "\201C" "\201D" "\2018" "\2019"; }
small { font-size: 80%; }
sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; }
sup { top: -0.5em; }
sub { bottom: -0.25em; }
img { border: 0; }
svg:not(:root) { overflow: hidden; }
figure { margin: 0; }
fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; }
legend { border: 0; padding: 0; }
button, input, select, textarea { font-family: inherit; font-size: 100%; margin: 0; }
button, input { line-height: normal; }
button, select { text-transform: none; }
button, html input[type="button"], input[type="reset"], input[type="submit"] { -webkit-appearance: button; cursor: pointer; }
button[disabled], html input[disabled] { cursor: default; }
input[type="checkbox"], input[type="radio"] { box-sizing: border-box; padding: 0; }
input[type="search"] { -webkit-appearance: textfield; -moz-box-sizing: content-box; -webkit-box-sizing: content-box; box-sizing: content-box; }
input[type="search"]::-webkit-search-cancel-button, input[type="search"]::-webkit-search-decoration { -webkit-appearance: none; }
button::-moz-focus-inner, input::-moz-focus-inner { border: 0; padding: 0; }
textarea { overflow: auto; vertical-align: top; }
table { border-collapse: collapse; border-spacing: 0; }
*, *:before, *:after { -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
html, body { font-size: 100%; }
body { background: white; color: #222222; padding: 0; margin: 0; font-family: "Helvetica Neue", "Helvetica", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; line-height: 1; position: relative; }
a:focus { outline: none; }
img, object, embed { max-width: 100%; height: auto; }
object, embed { height: 100%; }
img { -ms-interpolation-mode: bicubic; }
#map_canvas img, #map_canvas embed, #map_canvas object, .map_canvas img, .map_canvas embed, .map_canvas object { max-width: none !important; }
.left { float: left !important; }
.right { float: right !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }
.text-center { text-align: center !important; }
.text-justify { text-align: justify !important; }
.hide { display: none; }
.antialiased, body { -webkit-font-smoothing: antialiased; }
img { display: inline-block; }
textarea { height: auto; min-height: 50px; }
select { width: 100%; }
p.lead, .paragraph.lead > p, #preamble > .sectionbody > .paragraph:first-of-type p { font-size: 1.21875em; line-height: 1.6; }
.subheader, .admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .ulist > .title, .olist > .title, .dlist > .title, .qlist > .title, .tableblock > caption { line-height: 1.4; color: #7a2518; font-weight: 300; margin-top: 0.2em; margin-bottom: 0.5em; }
div, dl, dt, dd, ul, ol, li, h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6, pre, form, p, blockquote, th, td { margin: 0; padding: 0; direction: ltr; }
a { color: #005498; text-decoration: underline; line-height: inherit; }
a:hover, a:focus { color: #00467f; }
a img { border: none; }
p { font-family: inherit; font-weight: normal; font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; text-rendering: optimizeLegibility; }
p aside { font-size: 0.875em; line-height: 1.35; font-style: italic; }
h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { font-family: Georgia, "URW Bookman L", Helvetica, Arial, sans-serif; font-weight: normal; font-style: normal; color: #ba3925; text-rendering: optimizeLegibility; margin-top: 1em; margin-bottom: 0.5em; line-height: 1.2125em; }
h1 small, h2 small, h3 small, #toctitle small, .sidebarblock > .content > .title small, h4 small, h5 small, h6 small { font-size: 60%; color: #e99b8f; line-height: 0; }
h1 { font-size: 2.125em; }
h2 { font-size: 1.6875em; }
h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.375em; }
h4 { font-size: 1.125em; }
h5 { font-size: 1.125em; }
h6 { font-size: 1em; }
hr { border: solid #dddddd; border-width: 1px 0 0; clear: both; margin: 1.25em 0 1.1875em; height: 0; }
em, i { font-style: italic; line-height: inherit; }
strong, b { font-weight: bold; line-height: inherit; }
small { font-size: 60%; line-height: inherit; }
code, tt { font-family: Consolas, "Liberation Mono", Courier, monospace; font-weight: normal; color: #6d180b; }
ul, ol, dl { font-size: 1em; line-height: 1.6; margin-bottom: 1.25em; list-style-position: outside; font-family: inherit; }
ul li ul, ul li ol { margin-left: 1.5em; margin-bottom: 0; font-size: 1em; }
ul.square li ul, ul.circle li ul, ul.disc li ul { list-style: inherit; }
ul.square { list-style-type: square; }
ul.circle { list-style-type: circle; }
ul.disc { list-style-type: disc; }
ul.no-bullet { list-style: none; }
ol li ul, ol li ol { margin-left: 1.5em; margin-bottom: 0; }
dl dt { margin-bottom: 0.3125em; font-weight: bold; }
dl dd { margin-bottom: 1.25em; }
abbr, acronym { text-transform: uppercase; font-size: 90%; color: #222222; border-bottom: 1px dotted #dddddd; cursor: help; }
abbr { text-transform: none; }
blockquote { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
blockquote cite { display: block; font-size: inherit; color: #555555; }
blockquote cite:before { content: "\2014 \0020"; }
blockquote cite a, blockquote cite a:visited { color: #555555; }
blockquote, blockquote p { line-height: 1.6; color: #6f6f6f; }
.vcard { display: inline-block; margin: 0 0 1.25em 0; border: 1px solid #dddddd; padding: 0.625em 0.75em; }
.vcard li { margin: 0; display: block; }
.vcard .fn { font-weight: bold; font-size: 0.9375em; }
.vevent .summary { font-weight: bold; }
.vevent abbr { cursor: default; text-decoration: none; font-weight: bold; border: none; padding: 0 0.0625em; }
@media only screen and (min-width: 48em) { h1, h2, h3, #toctitle, .sidebarblock > .content > .title, h4, h5, h6 { line-height: 1.4; }
  h1 { font-size: 2.75em; }
  h2 { font-size: 2.3125em; }
  h3, #toctitle, .sidebarblock > .content > .title { font-size: 1.6875em; }
  h4 { font-size: 1.4375em; } }
.print-only { display: none !important; }
@media print { * { background: transparent !important; color: #000 !important; box-shadow: none !important; text-shadow: none !important; }
  a, a:visited { text-decoration: underline; }
  a[href]:after { content: " (" attr(href) ")"; }
  abbr[title]:after { content: " (" attr(title) ")"; }
  .ir a:after, a[href^="javascript:"]:after, a[href^="#"]:after { content: ""; }
  pre, blockquote { border: 1px solid #999; page-break-inside: avoid; }
  thead { display: table-header-group; }
  tr, img { page-break-inside: avoid; }
  img { max-width: 100% !important; }
  @page { margin: 0.5cm; }
  p, h2, h3, #toctitle, .sidebarblock > .content > .title { orphans: 3; widows: 3; }
  h2, h3, #toctitle, .sidebarblock > .content > .title { page-break-after: avoid; }
  .hide-on-print { display: none !important; }
  .print-only { display: block !important; }
  .hide-for-print { display: none !important; }
  .show-for-print { display: inherit !important; } }
table { background: white; margin-bottom: 1.25em; border: solid 1px #dddddd; }
table thead, table tfoot { background: whitesmoke; font-weight: bold; }
table thead tr th, table thead tr td, table tfoot tr th, table tfoot tr td { padding: 0.5em 0.625em 0.625em; font-size: inherit; color: #222222; text-align: left; }
table tr th, table tr td { padding: 0.5625em 0.625em; font-size: inherit; color: #222222; }
table tr.even, table tr.alt, table tr:nth-of-type(even) { background: #f9f9f9; }
table thead tr th, table tfoot tr th, table tbody tr td, table tr td, table tfoot tr td { display: table-cell; line-height: 1.6; }
pre > code, pre > tt { color: #222222; }
tt { font-size: 0.9375em; padding: 1px 3px 0; white-space: nowrap; background-color: #f2f2f2; border: 1px solid #cccccc; -webkit-border-radius: 4px; border-radius: 4px; text-shadow: none; }
kbd.keyseq { color: #555555; }
kbd:not(.keyseq) { display: inline-block; color: #222222; font-size: 0.75em; line-height: 1.4; background-color: #F7F7F7; border: 1px solid #ccc; -webkit-border-radius: 3px; border-radius: 3px; -webkit-box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; box-shadow: 0 1px 0 rgba(0, 0, 0, 0.2), 0 0 0 2px white inset; margin: -0.15em 0.15em 0 0.15em; padding: 0.2em 0.6em 0.2em 0.5em; vertical-align: middle; white-space: nowrap; }
kbd kbd:first-child { margin-left: 0; }
kbd kbd:last-child { margin-right: 0; }
.menuseq, .menu { color: #090909; }
p a > tt { text-decoration: underline; }
p a > tt:hover { color: #561309; }
#header, #content, #footnotes, #footer { width: 100%; margin-left: auto; margin-right: auto; margin-top: 0; margin-bottom: 0; max-width: 62.5em; *zoom: 1; position: relative; padding-left: 0.9375em; padding-right: 0.9375em; }
#header:before, #header:after, #content:before, #content:after, #footnotes:before, #footnotes:after, #footer:before, #footer:after { content: " "; display: table; }
#header:after, #content:after, #footnotes:after, #footer:after { clear: both; }
#header { margin-bottom: 2.5em; }
#header > h1 { color: black; font-weight: normal; border-bottom: 1px solid #dddddd; margin-bottom: -28px; padding-bottom: 32px; }
#header span { color: #6f6f6f; }
#header #revnumber { text-transform: capitalize; }
#header br { display: none; }
#header br + span { padding-left: 3px; }
#header br + span:before { content: "\2013 \0020"; }
#toc { border-bottom: 3px double #ebebeb; padding-bottom: 1.25em; }
#toc > ol { margin-left: 0.25em; }
#toc ol.sectlevel0 > li > a { font-style: italic; }
#toc ol.sectlevel0 ol.sectlevel1 { margin-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; }
#toc ol { list-style-type: none; }
#toctitle { color: #7a2518; }
@media only screen and (min-width: 80em) { body.toc2 { padding-left: 20em; }
  #toc.toc2 { position: fixed; width: 20em; left: 0; top: 0; border-right: 1px solid #ebebeb; border-bottom: 0; z-index: 1000; padding: 1em; height: 100%; overflow: auto; }
  #toc.toc2 #toctitle { margin-top: 0; }
  #toc.toc2 > ol { font-size: .95em; }
  #toc.toc2 ol ol { margin-left: 0; padding-left: 1em; }
  #toc.toc2 ol.sectlevel0 ol.sectlevel1 { padding-left: 0; margin-top: 0.5em; margin-bottom: 0.5em; } }
#footer { max-width: 100%; background-color: #222222; padding: 1.25em; }
#footer-text { color: #dddddd; line-height: 1.44; }
.sect1 { border-bottom: 3px double #ebebeb; padding-bottom: 1.25em; }
.sect1:last-of-type { border-bottom: 0; }
#content h1 > a.anchor, h2 > a.anchor, h3 > a.anchor, #toctitle > a.anchor, .sidebarblock > .content > .title > a.anchor, h4 > a.anchor, h5 > a.anchor, h6 > a.anchor { position: absolute; width: 1em; margin-left: -1em; display: block; text-decoration: none; visibility: hidden; text-align: center; font-weight: normal; }
#content h1 > a.anchor:before, h2 > a.anchor:before, h3 > a.anchor:before, #toctitle > a.anchor:before, .sidebarblock > .content > .title > a.anchor:before, h4 > a.anchor:before, h5 > a.anchor:before, h6 > a.anchor:before { content: '\00A7'; font-size: .85em; vertical-align: text-top; display: block; margin-top: 0.05em; }
#content h1:hover > a.anchor, #content h1 > a.anchor:hover, h2:hover > a.anchor, h2 > a.anchor:hover, h3:hover > a.anchor, #toctitle:hover > a.anchor, .sidebarblock > .content > .title:hover > a.anchor, h3 > a.anchor:hover, #toctitle > a.anchor:hover, .sidebarblock > .content > .title > a.anchor:hover, h4:hover > a.anchor, h4 > a.anchor:hover, h5:hover > a.anchor, h5 > a.anchor:hover, h6:hover > a.anchor, h6 > a.anchor:hover { visibility: visible; }
#content h1 > a.link, h2 > a.link, h3 > a.link, #toctitle > a.link, .sidebarblock > .content > .title > a.link, h4 > a.link, h5 > a.link, h6 > a.link { color: #ba3925; text-decoration: none; }
#content h1 > a.link:hover, h2 > a.link:hover, h3 > a.link:hover, #toctitle > a.link:hover, .sidebarblock > .content > .title > a.link:hover, h4 > a.link:hover, h5 > a.link:hover, h6 > a.link:hover { color: #a53221; }
.admonitionblock td.content > .title, .exampleblock > .title, .imageblock > .title, .listingblock > .title, .literalblock > .title, .openblock > .title, .paragraph > .title, .quoteblock > .title, .sidebarblock > .title, .tableblock > .title, .verseblock > .title, .ulist > .title, .olist > .title, .dlist > .title, .qlist > .title { text-align: left; font-weight: bold; }
.tableblock > caption { text-align: left; font-weight: bold; white-space: nowrap; overflow: visible; max-width: 0; }
table.tableblock #preamble > .sectionbody > .paragraph:first-of-type p { font-size: inherit; }
.admonitionblock > table { border: 0; background: none; width: 100%; }
.admonitionblock > table td.icon { text-align: center; width: 80px; }
.admonitionblock > table td.icon img { max-width: none; }
.admonitionblock > table td.icon .title { font-weight: bold; text-transform: uppercase; }
.admonitionblock > table td.content { padding-left: 1.125em; padding-right: 1.25em; border-left: 1px solid #dddddd; color: #6f6f6f; }
.admonitionblock > table td.content > .paragraph:last-child > p { margin-bottom: 0; }
.exampleblock > .content { border-style: solid; border-width: 1px; border-color: #e6e6e6; margin-bottom: 1.25em; padding: 1.25em; background: white; -webkit-border-radius: 4px; border-radius: 4px; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6, .exampleblock > .content p { color: #333333; }
.exampleblock > .content > :first-child { margin-top: 0; }
.exampleblock > .content > :last-child { margin-bottom: 0; }
.exampleblock > .content h1, .exampleblock > .content h2, .exampleblock > .content h3, .exampleblock > .content #toctitle, .sidebarblock.exampleblock > .content > .title, .exampleblock > .content h4, .exampleblock > .content h5, .exampleblock > .content h6 { line-height: 1; margin-bottom: 0.625em; }
.exampleblock > .content h1.subheader, .exampleblock > .content h2.subheader, .exampleblock > .content h3.subheader, .exampleblock > .content .subheader#toctitle, .sidebarblock.exampleblock > .content > .subheader.title, .exampleblock > .content h4.subheader, .exampleblock > .content h5.subheader, .exampleblock > .content h6.subheader { line-height: 1.4; }
.exampleblock > .content > :last-child > :last-child, .exampleblock > .content .olist > ol > li:last-child > :last-child, .exampleblock > .content .ulist > ul > li:last-child > :last-child, .exampleblock > .content .qlist > ol > li:last-child > :last-child { margin-bottom: 0; }
.exampleblock.result > .content { -webkit-box-shadow: 0 1px 8px #d9d9d9; box-shadow: 0 1px 8px #d9d9d9; }
.imageblock { margin-bottom: 1.25em; }
.sidebarblock { border-style: solid; border-width: 1px; border-color: #d9d9d9; margin-bottom: 1.25em; padding: 1.25em; background: #f2f2f2; -webkit-border-radius: 4px; border-radius: 4px; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6, .sidebarblock p { color: #333333; }
.sidebarblock > :first-child { margin-top: 0; }
.sidebarblock > :last-child { margin-bottom: 0; }
.sidebarblock h1, .sidebarblock h2, .sidebarblock h3, .sidebarblock #toctitle, .sidebarblock > .content > .title, .sidebarblock h4, .sidebarblock h5, .sidebarblock h6 { line-height: 1; margin-bottom: 0.625em; }
.sidebarblock h1.subheader, .sidebarblock h2.subheader, .sidebarblock h3.subheader, .sidebarblock .subheader#toctitle, .sidebarblock > .content > .subheader.title, .sidebarblock h4.subheader, .sidebarblock h5.subheader, .sidebarblock h6.subheader { line-height: 1.4; }
.sidebarblock > .content > .title { color: #7a2518; margin-top: 0; line-height: 1.6; }
.sidebarblock > .content > .paragraph:last-child p { margin-bottom: 0; }
pre { color: inherit; font-family: Consolas, "Liberation Mono", Courier, monospace; overflow-x: auto; line-height: 1.6; }
.verseblock { margin-bottom: 1.25em; }
.literalblock, .listingblock { margin-bottom: 1.25em; }
.literalblock > .content > pre, .listingblock > .content > pre { background: none; color: inherit; font-family: Consolas, "Liberation Mono", Courier, monospace; border-width: 1px 0; border-style: dotted; border-color: #bfbfbf; -webkit-border-radius: 4px; border-radius: 4px; padding: 0.75em 0.75em 0.5em 0.75em; white-space: pre; overflow-x: auto; line-height: 1.6; }
.literalblock > .content > pre > code, .literalblock > .content > pre > tt, .listingblock > .content > pre > code, .listingblock > .content > pre > tt { color: inherit; font-family: Consolas, "Liberation Mono", Courier, monospace; padding: 0; background: none; font-weight: normal; }
@media only screen { .literalblock > .content > pre, .listingblock > .content > pre { font-size: 0.8em; } }
@media only screen and (min-width: 48em) { .literalblock > .content > pre, .listingblock > .content > pre { font-size: 0.9em; } }
@media only screen and (min-width: 80em) { .literalblock > .content > pre, .listingblock > .content > pre { font-size: 1em; } }
.listingblock:hover .xml:before { content: "xml"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .html:before { content: "html"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .ruby:before { content: "ruby"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .asciidoc:before { content: "asciidoc"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .java:before { content: "java"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .javascript:before { content: "javascript"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .css:before { content: "css"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.listingblock:hover .scss:before { content: "scss"; text-transform: uppercase; float: right; font-size: 0.9em; color: #999; }
.quoteblock { margin: 0 0 1.25em; padding: 0.5625em 1.25em 0 1.1875em; border-left: 1px solid #dddddd; }
.quoteblock blockquote { margin: 0 0 1.25em 0; padding: 0 0 0.5625em 0; border: 0; }
.quoteblock blockquote > .paragraph:last-child p { margin-bottom: 0; }
.quoteblock .attribution { margin-top: -.25em; padding-bottom: 0.5625em; font-size: inherit; color: #555555; }
.quoteblock .attribution br { display: none; }
.quoteblock .attribution cite { display: block; margin-bottom: 0.625em; }
table thead th, table tfoot th { font-weight: bold; }
table.tableblock.grid-all { border-collapse: separate; border-spacing: 1px; -webkit-border-radius: 4px; border-radius: 4px; border-top: 1px solid #dddddd; border-bottom: 1px solid #dddddd; }
table.tableblock.frame-topbot, table.tableblock.frame-none { border-left: 0; border-right: 0; }
table.tableblock.frame-sides, table.tableblock.frame-none { border-top: 0; border-bottom: 0; }
table.tableblock td .paragraph:last-child p, table.tableblock td > p:last-child { margin-bottom: 0; }
th.tableblock.halign-left, td.tableblock.halign-left { text-align: left; }
th.tableblock.halign-right, td.tableblock.halign-right { text-align: right; }
th.tableblock.halign-center, td.tableblock.halign-center { text-align: center; }
th.tableblock.halign-top, td.tableblock.halign-top { vertical-align: top; }
th.tableblock.halign-bottom, td.tableblock.halign-bottom { vertical-align: bottom; }
th.tableblock.halign-middle, td.tableblock.halign-middle { vertical-align: middle; }
p.tableblock.header { color: #222222; font-weight: bold; }
td > div.verse { white-space: pre; }
ul { margin-left: 1.75em; }
ol { margin-left: 1.875em; }
dl dd { margin-left: 1.125em; }
dl dd:last-child, dl dd:last-child > :last-child { margin-bottom: 0; }
.unstyled dl dt { font-weight: normal; font-style: normal; }
ol > li p, ul > li p, ul dd, ol dd { margin-bottom: 0.625em; }
ol.arabic { list-style-type: decimal; }
ol.loweralpha { list-style-type: lower-alpha; }
ol.upperalpha { list-style-type: upper-alpha; }
ol.lowerroman { list-style-type: lower-roman; }
ol.upperroman { list-style-type: upper-roman; }
.hdlist > table, .colist > table { border: 0; background: none; }
.hdlist > table > tbody > tr, .colist > table > tbody > tr { background: none; }
.literalblock + .colist, .listingblock + .colist { margin-top: -0.5em; }
.colist > table tr > td:first-of-type { padding: 0 .8em; line-height: 1; }
.colist > table tr > td:last-of-type { padding: 0.25em 0; }
td.hdlist1 { vertical-align: top; padding-right: .8em; font-weight: bold; }
.qanda > ol > li > p:first-child { color: #00467f; }
span.footnote, span.footnoteref { vertical-align: super; font-size: 0.875em; }
span.footnote a, span.footnoteref a { text-decoration: none; }
#footnotes { padding: 0.75em 0.375em; margin-bottom: 1.25em; #border-top: 1px solid #dddddd; }
#footnotes hr { width: 20%; min-width: 6.25em; margin: -.25em 0 .75em 0; border-width: 1px 0 0 0; }
#footnotes .footnote { line-height: 1.3; font-size: 0.875em; margin-left: 1.2em; text-indent: -1.2em; margin-bottom: .2em; }
#footnotes .footnote a { font-weight: bold; text-decoration: none; }
#footnotes .footnote:last-of-type { margin-bottom: 0; }
.gist .file-data > table { border: none; background: #fff; width: 100%; margin-bottom: 0; }
.gist .file-data > table td.line-data { width: 99%; }
div.unbreakable { page-break-inside: avoid; }
.big { font-size: larger; }
.small { font-size: smaller; }
.underline { text-decoration: underline; }
.overline { text-decoration: overline; }
.line-through { text-decoration: line-through; }
.aqua { color: #00bfbf; }
.aqua-background { background-color: #00fafa; }
.black { color: black; }
.black-background { background-color: black; }
.blue { color: #0000bf; }
.blue-background { background-color: #0000fa; }
.fuchsia { color: #bf00bf; }
.fuchsia-background { background-color: #fa00fa; }
.gray { color: #606060; }
.gray-background { background-color: #7d7d7d; }
.green { color: #006000; }
.green-background { background-color: #007d00; }
.lime { color: #00bf00; }
.lime-background { background-color: #00fa00; }
.maroon { color: #600000; }
.maroon-background { background-color: #7d0000; }
.navy { color: #000060; }
.navy-background { background-color: #00007d; }
.olive { color: #606000; }
.olive-background { background-color: #7d7d00; }
.purple { color: #600060; }
.purple-background { background-color: #7d007d; }
.red { color: #bf0000; }
.red-background { background-color: #fa0000; }
.silver { color: #909090; }
.silver-background { background-color: #bcbcbc; }
.teal { color: #006060; }
.teal-background { background-color: #007d7d; }
.white { color: #bfbfbf; }
.white-background { background-color: #fafafa; }
.yellow { color: #bfbf00; }
.yellow-background { background-color: #fafa00; }
.admonitionblock td.icon [class^="icon-"]:before { font-size: 2.5em; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); cursor: default; }
.admonitionblock td.icon .icon-note:before { content: "\f05a"; color: #005498; color: #003f72; }
.admonitionblock td.icon .icon-tip:before { content: "\f0eb"; text-shadow: 1px 1px 2px rgba(155, 155, 0, 0.8); color: #111; }
.admonitionblock td.icon .icon-warning:before { content: "\f071"; color: #bf6900; }
.admonitionblock td.icon .icon-caution:before { content: "\f06d"; color: #bf3400; }
.admonitionblock td.icon .icon-important:before { content: "\f06a"; color: #bf0000; }
.conum { display: inline-block; color: white !important; background-color: #222222; -webkit-border-radius: 100px; border-radius: 100px; text-align: center; width: 20px; height: 20px; font-size: 12px; font-weight: bold; line-height: 20px; font-family: Arial, sans-serif; font-style: normal; position: relative; top: -2px; letter-spacing: -1px; }
.conum * { color: white !important; }
.conum:empty { display: none; }
pre .comment .conum { left: -20px; }
.literalblock > .content > pre, .listingblock > .content > pre { -webkit-border-radius: 0; border-radius: 0; }

</style>
</head>
<body class="book">
<div id="header">
<h1>The Clojure Omnibus</h1>
<span id="author">Laurent Petit</span><br>
<span id="email"><a href="mailto:laurent.petit@gmail.com">laurent.petit@gmail.com</a></span><br>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Oct, 31 2013</p>
</div>
<div class="paragraph">
<p>This post is a port of the blog post <a href="http://www.code-story.net/blog/posts/s03e01.3">The Java Omnibus</a> to the <a href="http://www.clojure.org">Clojure</a> language.<br>
It targets developers beginning or with some notions of Clojure, who want to quickly get up to speed with the episode&#8217;s algorithm challenge.</p>
</div>

</div>
</div>
<div class="sect1">
<h2 id="_the_tale_of_two_servers">The Tale Of Two Servers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The goal of Code-Story <a href="http://www.code-story.net/blog/posts/s03e01.1">episode S03E01</a> is to code the algorithm that moves an elevator&#8217;s <code>cabin</code> within a <code>building</code>.</p>
</div>
<div class="paragraph">
<p>There are two systems, the <code>building</code>, and the <code>cabin</code>. Two pieces of software, one for each. The Code-Story Team provides the <code>building</code> server and we (the competitors) write the <code>cabin</code> server.</p>
</div>
<div class="paragraph">
<p>The Code-Story team provides a building server, which patiently waits for cabin server registrations. You manually register your cabin server through a dedicated web page: by giving its ip and port. Then the building server starts calling your cabin server periodically.</p>
</div>
<div class="paragraph">
<p>When the building server calls your cabin server, it describes what&#8217;s happening. In this simulation, there is a limited set of events. People in the building can call the cabin from their floor. They can enter. Once inside the cabin they state at which floor they want to leave. Once the cabin is at the right floor they exit when it opens its doors.</p>
</div>
<div class="paragraph">
<p>That&#8217;s all.</p>
</div>
<div class="paragraph">
<p>The building server is going to call the cabin server through repeated http calls. For instance when someone enters the cabin, the building server calls the <code>/userHasEntered</code> url on the cabin server. When a user calls the elevator, the building server is going to call the <code>/call</code> url passing in query parameters the floor at which the call was made.</p>
</div>
<div class="sect2">
<h3 id="_the_short_version">The Short Version</h3>
<div class="ulist">

<ul>
<li>
<p>The Code-Story team will provide a server for the building</p>
</li>
<li>
<p>You need to code a cabin server</p>
</li>
<li>
<p>This cabin server code must be some kind of http server</p>
</li>
<li>
<p>It needs to listen to a few dedicated url</p>
</li>
<li>
<p>To get started, you need to register the cabin server by hand on a dedicated web page served by the building server.</p>
</li>
</ul>
</div>

</div>
<div class="sect2">
<h3 id="_events">Events</h3>
<div class="paragraph">
<p>The starting position of the cabin is at the lowest floor, doors closed, and no user is in the building or the cabin, yet.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the list of http requests your cabin server needs to listen to. All the calls are made with a http <code>GET</code> verb.</p>
</div>
<div class="ulist">

<ul>
<li>
<p><code>/call?atFloor=[0-5]</code> means someone is waiting at floor <code>atFloor</code> to get into the cabin</p>
</li>
<li>
<p><code>/userHasEntered</code> means someone just entered the cabin</p>
</li>
<li>
<p><code>/go?floorToGo=[0-5]</code> means someone, who just got into the cabin, wants to leave the cabin at floor <code>floorToGo</code></p>
</li>
<li>
<p><code>/userHasExited</code> means someone just exited the cabin.</p>
</li>
<li>
<p><code>/reset</code> is issued to resynchronize the building and cabin states to the starting position. It can occur if the cabin made an impossible move, for instance going below the lowest floor for instance, or moving while the doors are open.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For the building server to be happy you just need to answer with a <code>200 OK</code> HTTP response.</p>
</div>

</div>
<div class="sect2">
<h3 id="_nextcommand">nextCommand</h3>
<div class="paragraph">
<p>But the cabin needs to take some action, so answering empty text is not going to lead it anywhere.</p>
</div>
<div class="paragraph">
<p>The building server will issue regularly some <code>/nextCommand</code> waiting for a proper answer. The answer you can give back to the building server is one of the following</p>
</div>
<div class="ulist">

<ul>
<li>
<p><code>OPEN</code>: you open the doors of the cabin</p>
</li>
<li>
<p><code>CLOSE</code>: you close the doors of the cabin</p>
</li>
<li>
<p><code>UP</code>: you want the cabin to go up one floor</p>
</li>
<li>
<p><code>DOWN</code>: you want the cabin to go down one floor</p>
</li>
<li>
<p><code>NOTHING</code>: the cabin does nothing.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So when the server wants to know what the cabin is doing, you must answer one of this 5 answers with a <code>200 OK</code> (and a <code>Content-Type: plain/text</code>).</p>
</div>

</div>

</div>
</div>
<div class="sect1">
<h2 id="_enough_talking_let_s_code">Enough Talking, Let&#8217;s Code !</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_pre_requisite">Pre-Requisite</h3>
<div class="paragraph">
<p>You must have:</p>
</div>
<div class="ulist">

<ul>
<li>
<p>Jdk7+</p>
</li>
<li>
<p>Leiningen 2</p>
</li>
<li>
<p>Git</p>
</li>
<li>
<p>Basic knowledge of http server</p>
</li>
</ul>
</div>

</div>
<div class="sect2">
<h3 id="_the_building_server">The Building Server</h3>
<div class="paragraph">
<p>The building server can be obtained on Github at <a href="https://github.com/jeanlaurent/code-elevator">https://github.com/jeanlaurent/code-elevator</a></p>
</div>
<div class="paragraph">
<p>You should first get it running just to see how it works:</p>
</div>
<div class="literalblock">

<div class="content monospaced">
<pre>git clone https://github.com/jeanlaurent/code-elevator
./run.sh</pre>
</div>
</div>
<div class="paragraph">
<p>Then open your favorite browser and go to <a href="http://localhost:8080/">http://localhost:8080/</a></p>
</div>
<div class="paragraph">
<p>You can register yourself with a fancy url just to see how it works. Type in your name, some email and let&#8217;s say <a href="http://127.0.0.1:9090/">http://127.0.0.1:9090/</a></p>
</div>
<div class="paragraph">
<p>You can now have a glimpse at the cabin, and the building. The building&#8217;s server at <a href="http://localhost:8080/">http://localhost:8080/</a> tries to connect to a cabin server at <a href="http://localhost:9090/">http://localhost:9090/</a> but finds nothing, and spurs error after error.</p>
</div>
<div class="paragraph">
<p>Notice the points goes down quite a bit. So you should probably unregister.</p>
</div>
<div class="paragraph">
<p>Now we need to start coding.</p>
</div>

</div>
<div class="sect2">
<h3 id="_simple_server">Simple Server</h3>
<div class="paragraph">
<p>In the Clojure world, the first thing you must write is a Clojure file named <code>project.clj</code> like this:</p>
</div>
<div class="listingblock">
<div class="title">project.clj</div>
<div class="content monospaced">
<pre class="highlight"><code class="clojure language-clojure">(defproject elevator "0.0.1-SNAPSHOT"
  :dependencies [ [org.clojure/clojure     "1.5.1"]
                  [compojure               "1.1.5"]      ; <b>&lt;1&gt;</b>
                  [ring/ring-jetty-adapter "1.2.0"] ])   ; <b>&lt;2&gt;</b></code></pre>
</div>
</div>
<div class="colist arabic">

<ol>
<li>
<p>Compojure is a library for writing Web applications. It comprises: an HTTP request/response abstraction (based on the Ring library), and features to create "HTTP Request Routes" (mapping request URLs to functions which will process the request - the <em>handlers</em> -). A word on Ring: it is a library which abstracts HTTP requests and responses as plain Clojure maps. The possible keys for the request and response maps are formalized in a <a href="https://github.com/ring-clojure/ring/blob/master/SPEC">specifications document</a> and are an integral part of the Ring API. This is a classical trait of Clojure libraries: standardizing on information/data first, and behavior (functions) second.</p>
</li>
<li>
<p>ring-jetty-adapter is an optional module of the Ring HTTP library for easy integration with the Jetty web server library.</p>
</li>
</ol>
</div>

</div>
<div class="sect2">
<h3 id="_not_loosing_is_winning">Not Loosing Is Winning ?</h3>
<div class="paragraph">
<p>To make things simple, first let&#8217;s start by not losing points. You lose points by actually not answering to all calls or answering them with something else than a <code>200 OK</code>. So we should write a server which answers <code>200 OK</code> to any call, regardless of the actual meaning of the call. And we should answer <code>NOTHING</code> to every <code>/nextCommand</code> calls.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s use the Compojure web library which enables us to start quickly writing some interesting code.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s create file <code>main.clj</code> in the <code>src</code> folder:</p>
</div>
<div class="listingblock">
<div class="title">src/main.clj</div>
<div class="content monospaced">
<pre class="highlight"><code class="clojure language-clojure">(ns main
  (:use ring.adapter.jetty
        compojure.core))

(defroutes app
  (GET "/nextCommand" [] "NOTHING")   <b>&lt;1&gt;</b>
  (GET "*"            [] ""))         <b>&lt;2&gt;</b>

(defn -main []
  (run-jetty app {:port 9090}))</code></pre>
</div>
</div>
<div class="colist arabic">

<ol>
<li>
<p>If the route is <code>/nextCommand</code> answer <code>200 OK</code> (implied) with <code>NOTHING</code> in the payload</p>
</li>
<li>
<p>If the route is something else answer <code>200 OK</code> (implied) with an empty payload</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now run the <code>-main</code> function of the <code>main</code> namespace, by invoking Leiningen on the command line:</p>
</div>
<div class="literalblock">

<div class="content monospaced">
<pre>$ lein run -m main
2013-10-24 23:54:58.424:INFO:oejs.Server:jetty-7.6.8.v20121106
2013-10-24 23:54:58.511:INFO:oejs.AbstractConnector:Started SelectChannelConnector@0.0.0.0:9090</pre>
</div>
</div>
<div class="paragraph">
<p>Then register again in your building server. You should see that the score now stays at zero. You&#8217;ll notice also that some people are actually calling our cabin, but as every time the building server calls the <code>nextCommand</code> the cabin answers <code>NOTHING</code>, nothing moves, and the people can die waiting for the cabin to come.</p>
</div>

</div>
<div class="sect2">
<h3 id="_srp">SRP</h3>
<div class="paragraph">
<p>But the server code is not going to change much, while the elevator code is. The elevator code is where everything is going to happen. And as you know your SRP principle by heart, <em>“a function has one reason to change, and only one”</em>, We are going to split the responsibilities: the route dispatching, the http-level request handling, and the cabin (logic stuff, http agnostic).</p>
</div>
<div class="paragraph">
<p>In a real Clojure application, we may start to engineer a little bit more, and create a separate namespace for the elevator (logic) stuff. There&#8217;s no real pressure to do so right now, so we&#8217;ll keep things simple and just use one namespace.</p>
</div>
<div class="paragraph">
<p>Change the <code>main.clj</code> file like so:</p>
</div>
<div class="listingblock">
<div class="title">src/main.clj</div>
<div class="content monospaced">
<pre class="highlight"><code class="clojure language-clojure">(ns main
  (:use ring.adapter.jetty
        compojure.core))

(defn next-command [] "NOTHING")                 ; <b>&lt;1&gt;</b>

(defn next-command-handler [] (next-command))    ; <b>&lt;2&gt;</b>

(defroutes app
  (GET "/nextCommand" [] (next-command-handler)) ; <b>&lt;3&gt;</b>
  (GET "*"            [] ""))

(defn -main []
  (run-jetty app {:port 9090}))</code></pre>
</div>
</div>
<div class="colist arabic">

<ol>
<li>
<p>The <code>next-command</code> function implements the core logic. Granted, it is quite simple at the moment</p>
</li>
<li>
<p>The <code>next-command-handler</code> function is the interface between the Web World and our web-agnostic algorithm in <code>next-command</code>. Granted, it does not do much at the moment. Be patient ;-)</p>
</li>
<li>
<p>The routes definition directly calls <code>next-command-handler</code>. When time will come to e.g. extract parameters from the Request, this separation of concern will prove more useful.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">

<div class="paragraph">
<p>While we didn&#8217;t really feel any pressure to create 2 levels of indirection (<code>next-command-handler</code>, and then <code>next-command</code>), they have been introduced at once to keep this article shorter. In the real world, an intermediate shape of the code could have been to have <code>next-command-handler</code> directly return "NOTHING", saving the introduction of the <code>next-command</code> function for later.</p>
</div>

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Clojure code puts a strong emphasis on application state management. The less state, the less moving parts, the better. So for the moment, the algorithm requires absolutely no state, and there&#8217;s indeed no state in the code. Not even yet a kind of "Cabin instance". Just a separation of concerns via the introduction of an indirection level.</p>
</div>
<div class="paragraph">
<p>Stop and restart your server via the Leiningen command line and check that the number of points in the building server web page still doesn&#8217;t change. We have made some baby steps to be ready to code an efficient (<em>cough, cough</em>) algorithm now.</p>
</div>

</div>
<div class="sect2">
<h3 id="_the_omnibus">The Omnibus</h3>
<div class="paragraph">
<p>The Omnibus Elevator algorithm is a very good starter because you only have to take care of the <code>nextCommand</code> call and know the number of floors in the building.</p>
</div>
<div class="paragraph">
<p>By chance we know it&#8217;s a 20 story building (it&#8217;s a little bit more dynamic than that, but at least for the first week, it&#8217;s 20 floors).</p>
</div>
<div class="paragraph">
<p>The Omnibus idea is to go to each floor, open the doors, close them and go to the next floor. We do this up and down, all the time. By doing this, we are pretty sure to get anyone waiting in the cabin, and anyone who may want to leave can since we stop at any floors by going up or down. This is not efficient. But this is a very good first baby step into the problem to learn more on the way.</p>
</div>
<div class="paragraph">
<p>One thing to know, or notice by doing that, is that all the people waiting at a given floor will rush into the cabin as soon as it opens, and all the people inside will rush out at the same time. So you don&#8217;t need to wait for people to get in or out.</p>
</div>
<div class="paragraph">
<p>We should start using the other commands at our disposal, rather than answering <code>NOTHING</code>.</p>
</div>
<div class="paragraph">
<p>At a given floor we should first answer <code>OPEN</code>, then at the next <code>nextCommand</code> call we should answer <code>CLOSE</code>, then move <code>UP</code> or <code>DOWN</code> depending on the current direction of the cabin (ascending or descending phase).</p>
</div>
<div class="paragraph">
<p>So we have to issue 19 times a <code>OPEN</code>, <code>CLOSE</code>, <code>UP</code> commands and then <code>OPEN</code>, <code>CLOSE</code>, <code>DOWN</code>. Rather than keeping records of what floor the cabin currently is at, and writing the conditional logic for issuing an <code>OPEN</code>, <code>CLOSE</code>, <code>UP</code> or <code>DOWN</code> command, we can <strong>predetermine</strong> the full commands by creating an infinite lazing sequence cycling through the alternating 5x3 commands while the elevator is going up then 5x3 commands while the elevator is going down:</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="highlight"><code class="clojure language-clojure">(defn make-omnibus [nb-floors]
  (let [up   (repeat (dec nb-floors) ["OPEN", "CLOSE", "UP"])     ; <b>&lt;1&gt;</b>
        down (repeat (dec nb-floors) ["OPEN", "CLOSE", "DOWN"])
        up-then-down (flatten (concat up down))]                  ; <b>&lt;2&gt;</b>
    (concat ["NOTHING"] (cycle up-then-down))))                   ; <b>&lt;3&gt;</b></code></pre>
</div>
</div>
<div class="colist arabic">

<ol>
<li>
<p><code>dec</code> is the decrement function: <code>(dec 2)</code> returns <code>1</code> (see <a href="http://clojuredocs.org/clojure_core/clojure.core/dec">ClojureDocs</a> or <a href="http://clojure.github.io/clojure/clojure.core-api.html#clojure.core/dec">Reference Doc</a>). <code>(repeat n a-sequence)</code> produces a sequence repeating <code>a-sequence</code> <code>n</code> times: <code>(repeat 3 ["O", "P"])</code> returns <code>(["O", "P"], ["O", "P"], ["O", "P"])</code> (see <a href="http://clojuredocs.org/clojure_core/clojure.core/repeat">ClojureDocs</a> or <a href="http://clojure.github.io/clojure/clojure.core-api.html#clojure.core/repeat">Reference Doc</a>)</p>
</li>
<li>
<p><code>concat</code> concatenates its sequence arguments: <code>(concat [1 2] [3 4])</code> returns <code>(1 2 3 4)</code> (see <a href="http://clojuredocs.org/clojure_core/clojure.core/concat">ClojureDocs</a> or <a href="http://clojure.github.io/clojure/clojure.core-api.html#clojure.core/concat">Reference Doc</a>). <code>flatten</code> transforms nested sequences into a flat sequence: <code>(flatten [ [1 2] [3 4] ])</code> returns <code>(1 2 3 4)</code> (see <a href="http://clojuredocs.org/clojure_core/clojure.core/flatten">ClojureDocs</a> or <a href="http://clojure.github.io/clojure/clojure.core-api.html#clojure.core/flatten">Reference doc</a>)</p>
</li>
<li>
<p><code>cycle</code> creates an infinite sequence as if concatenating its sequence argument to itself, again and again and again: <code>(cycle [1, 2, 3, 2])</code> returns <code>(1 2 3 2 1 2 3 2 1 ...)</code> (see <a href="http://clojuredocs.org/clojure_core/clojure.core/cycle">ClojureDocs</a> or <a href="http://clojure.github.io/clojure/clojure.core-api.html#clojure.core/cycle">Reference Doc</a>). You may have noted that the input types are of the type <code>[ xx, yy ]</code> while the output types are of the type <code>( xx, yy )</code>. <code>[1 2]</code> is a vector, a datastructure. <code>(1 2)</code> is a seq(uence). <code>repeat</code>, <code>concat</code> and <code>cycle</code> return lazy seqs: their elements aren&#8217;t all computed yet ; they are computed just in time, when their are traversed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The function <code>make-omnibus</code> returns a lazy-sequence whose shape depends on the number of floors. For 2 floors, it would return <code>("NOTHING", "OPEN", "CLOSE", "UP", "OPEN", "CLOSE", "DOWN", "OPEN", "CLOSE", "UP", "OPEN", "CLOSE", "DOWN", "OPEN" .....)</code>.</p>
</div>
<div class="paragraph">
<p>For the Omnibus algorithm, we need to store the state of the elevator cabin.<br>
Clojure promotes strict separation of concepts of identity, state and value. In a nutshell, it means we will use pure functions at the core of our algorithm, and manage state change at the boundaries of the program. Request handlers will be responsible for managing the state of the elevator cabin (get the previous state, store the new state. The hard work will be delegated to pure functions).</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">

<div class="paragraph">
<p>The <code>nextCommand</code> event is interesting. It acts both as an event indicating that the elevator should compute its next command, and it also acts as a getter to query the new state. As you may have learned from good principles from Object Orientation, it&#8217;s generally not a good idea to have a getter that also changes the internal state of the object.<br>
The same applies to Clojure.</p>
</div>

</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the Omnibus algorithm, the state is an infinite list of pre-determined commands to issue. To compute the next state, we just remove one element from the list and make this the new state.</p>
</div>
<div class="paragraph">
<p>We cannot change the external API of our cabin, it is dictated by the rules of the contest. But we can avoid to propagate this design decision to the core of our algorithm. So we&#8217;ll deal with a coumpound <code>nextCommand</code> at the request handler level: we&#8217;ll split the <code>nextCommand</code> into a <code>tick</code> state-altering Event and a <code>next-command</code> state-preserving/idempotent Getter.</p>
</div>
<div class="listingblock">

<div class="content monospaced">
<pre class="highlight"><code class="clojure language-clojure">(defn tick [elevator] (rest elevator))           ; <b>&lt;2&gt;</b>
(defn next-command [elevator] (first elevator))  ; <b>&lt;3&gt;</b>

(def nb-floors 20)
(def cabin (atom (make-omnibus nb-floors)))      ; <b>&lt;1&gt;</b>
(defn next-command-handler []                    ; <b>&lt;4&gt;</b>
  (let [new-state (swap! cabin tick)]
    (next-command new-state)))

(defroutes app
  (GET "/nextCommand" [] (next-command-handler)) ; <b>&lt;5&gt;</b>
  ...)</code></pre>
</div>
</div>
<div class="colist arabic">

<ol>
<li>
<p>The <code>cabin</code> is the piece of state of the application. Here we just encapsulate the state in an atom. An atom is one of the simplest state referencing types of Clojure: an atom holds a value, and has clearly established synchronous functions that can be applied to it to change the value it contains. Underneath, it really is a java.util.concurrent.Atom instance (see <a href="http://clojuredocs.org/clojure_core/clojure.core/atom">ClojureDocs</a> or <a href="http://clojure.github.io/clojure/clojure.core-api.html#clojure.core/atom">Reference Doc</a>).</p>
</li>
<li>
<p>The <code>tick</code> function removes the head of the list and returns the new list. The effect is that the state rotates the list of one element.</p>
</li>
<li>
<p>The <code>next-command</code> just returns the head of the list. Note that it&#8217;s an idempotent function. It does not change the state of the cabin.</p>
</li>
<li>
<p>The <code>next-command-handler</code> modifies the cabin state: <code>swap!</code> calls the <code>tick</code> function to the current state value, and the state becomes the result of the call to <code>tick</code> (see <a href="http://clojuredocs.org/clojure_core/clojure.core/swap!">ClojureDocs</a> or <a href="http://clojure.github.io/clojure/clojure.core-api.html#clojure.core/swap!">Reference Doc</a>). Then <code>next-command</code> is called on the new state.</p>
</li>
<li>
<p>Note that we changed the name of the handler for the <code>/nextCommand</code> route from <code>next-command</code> to <code>next-command-handler</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now stop and start the server again, via Leiningen. You should see your elevator going up and down, starting to get people on board.</p>
</div>

</div>
<div class="sect2">
<h3 id="_final_code">Final code</h3>
<div class="paragraph">
<p>Since there is still so little code for the Omnibus implementation, please find it all below:</p>
</div>
<div class="listingblock">
<div class="title">project.clj</div>
<div class="content monospaced">
<pre class="highlight"><code class="clojure language-clojure">(defproject elevator "0.0.1-SNAPSHOT"
  :dependencies [ [org.clojure/clojure     "1.5.1"]
                  [compojure               "1.1.5"]
                  [ring/ring-jetty-adapter "1.2.0"] ])</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main.clj</div>
<div class="content monospaced">
<pre class="highlight"><code class="clojure language-clojure">(ns main
  (:use ring.adapter.jetty
        compojure.core))

(defn make-omnibus [nb-floors]
  (let [up   (repeat (dec nb-floors) ["OPEN", "CLOSE", "UP"])
        down (repeat (dec nb-floors) ["OPEN", "CLOSE", "DOWN"])
        up-then-down (flatten (concat up down))]
    (concat ["NOTHING"] (cycle up-then-down))))

(defn tick [elevator] (rest elevator))
(defn next-command [elevator] (first elevator))

(def nb-floors 20)
(def cabin (atom (make-omnibus nb-floors)))
(defn next-command-handler []
  (let [new-state (swap! cabin tick)]
    (next-command new-state)))

(defroutes app
  (GET "/nextCommand" [] (next-command-handler))
  (GET "*"            [] ""))

(defn -main []
  (run-jetty app {:port 9090}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Laurent Petit</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">

<div class="paragraph">
<p>To keep this post short and friendly for people new to Clojure, I&#8217;ve intentionally made some choices in what is presented. For instance, I&#8217;m not talking about interactive development at all. I&#8217;m also using the short <code>(:use)</code> directive in the namespace declaration instead of <code>(:require)</code>.<br>
I&#8217;ve also made the choice in this first version to explain how to start the project from the command line. I intend to adapt it to Counterclockwise + Eclipse, especially to make it easier for Windows people to start.</p>
</div>

</td>
</tr>
</table>
</div>

</div>

</div>
</div>

</div>
<div id="footer">
<div id="footer-text">
Last updated 2013-11-05 02:08:54 CET
</div>
</div>
</body>
</html>